{% extends 'board/base.html' %}
{% load staticfiles %}

{% block script %}
<script>
    $(document).ready(function () {
        $("#rank_btn").click(function () {
            if ($("#rank_btn").val() == "우선 순위 변경") {
                sort()
                $("#rank_btn").attr('class','btn btn-danger')
                $("#rank_btn").val('저장')
                $("#add_post_btn").hide()
                $("#rank_help").show()
                $(".btn-success").attr('disabled', true)
            }
            else {
                rank_change()
                $("#rank_btn").attr('class','btn')
                $("#rank_btn").val('우선 순위 변경')
                $("#add_post_btn").show()
                $("#rank_help").hide()
                $(".btn-success").attr('disabled', false)
            }
        });
    });

    // 우선 순위 리스트 움직일 수 있게끔 설정
    function sort() {
        $(function () {
            $("#sortable").sortable();
            $("#sortable").disableSelection();
        });
    }

    // 변경된 우선 순위 적용
    function rank_change() {
        // 배열 생성
        var orderlist = $("#sortable").sortable("toArray");

        // 배열을 POST 로 넘김
        $.ajax({
            url: "{% url 'board:update_post_list_rank' %}",
            type: "POST",
            data: {
                "orderlist": orderlist.toString(),
                "csrfmiddlewaretoken": "{{csrf_token}}",
            },

            async: false,
            cache: false,
            success: function (data) {
                if (data == "OK") {
                    alert("변경 내용이 저장되었습니다.");
                    window.location.reload(true); //현재화면 새로고침
                }
            },
            error: function (request, status, error) {
                alert("orderlist:" + orderlist + "\n" + "code:" + request.status + "\n" + "message:" + request.responseText + "\n" + "error:" + error);
            }
        })
    }

    // 항목 완료 체크버튼 눌렀을 때,
    function complete_btn(id) {
        var url = "{% url 'board:complete' 'id' 'board:post_list' %}".replace("id", id)
        if (confirm('완료 처리하시겠습니까?')) {
            location.href = url
        }
    }

    // 항목 추가 버튼눌렀을 때,
    function add_post_btn() {
        location.href = "{% url 'board:add_post' %}"
    }
</script>
{% endblock %}

{% block content %}
<!-- 사용되는 버튼들 -->
<div class="btn_group">
    <input type="button" class="btn" id="rank_btn" value="우선 순위 변경" />
    <input type="button" class="btn" id="add_post_btn" onclick=add_post_btn() value="+" />
    <span id="rank_help" style="display:none">* 리스트를 드래그 하여 우선 순위를 변경하여 주십시오.</span>
</div>
<!-- todo 항목 리스트의 헤더 -->
<ul id='todo_list_header'>
    <li><span class="col_rank">우선순위</span><span class="col_title">제목</span><span class="col_due_date">마감기한</span><span
            class="col_complete">완료</span></li>
</ul>
<!-- todo 항목 list -->
<div id="todo_list">
    <!-- 완료되지 않은 list -->
    <ul id="sortable">
        {% for post in post_list %}
        <li id={{forloop.counter}}>
            <span class="col_rank">{{post.rank |floatformat:"0"}}</span>
            <span class="col_title"><a href="{% url 'board:post_detail' post.id %}">{{post.title}}</a></span>
            <span class="col_due_date">
                {% if post.due_chk %}
                {{post.due_date|date:'Y-m-d'}}
                {% else %}
                -
                {% endif %}
            </span>
            <span class="col_complete   ">
                
                <input type="button" class="btn btn-success" onclick=complete_btn("{{post.id}}") value="확인" />
            </span>
        </li>
        {% endfor %}
    </ul>

    <!-- 완료된 list -->
    <ul id="fixed">
        {% for post in post_list_complete %}
        <li>
            <span class="col_rank">-</span>
            <span class="col_title"><a href="{% url 'board:post_detail' post.id %}">{{post.title}}</a></span>
            <span class="col_due_date">
                {% if post.due_chk %}
                {{post.due_date|date:'Y-m-d'}}
                {% else %}
                -
                {% endif %}
            </span>
            <span class="col_complete">O</span>
        </li>
        {% endfor %}
    </ul>
</div>
{% endblock %}